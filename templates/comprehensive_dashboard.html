{% extends "base.html" %}

{% block title %}Dashboard - Comprehensive Farm Expense Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2 class="mb-4">
            <i class="fas fa-tractor me-2"></i>Comprehensive Farm Dashboard
            {% if current_user.farm_name %}
            <small class="text-muted">- {{ current_user.farm_name }}</small>
            {% endif %}
        </h2>
    </div>
</div>

<!-- Enhanced Statistics Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title mb-1">
                            <i class="fas fa-rupee-sign me-2"></i>Total Expenses
                        </h6>
                        <h3 class="mb-0">₹{{ "%.2f"|format(total_expenses) }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x opacity-50"></i>
                    </div>
                </div>
                {% if cost_per_acre > 0 %}
                <small>₹{{ "%.2f"|format(cost_per_acre) }} per acre</small>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title mb-1">
                            <i class="fas fa-receipt me-2"></i>Total Entries
                        </h6>
                        <h3 class="mb-0">{{ total_comprehensive_expenses + total_bills }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-list fa-2x opacity-50"></i>
                    </div>
                </div>
                <small>{{ total_comprehensive_expenses }} expenses, {{ total_bills }} bills</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title mb-1">
                            <i class="fas fa-mountain me-2"></i>Farm Area
                        </h6>
                        <h3 class="mb-0">{{ "%.1f"|format(total_acres) }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-seedling fa-2x opacity-50"></i>
                    </div>
                </div>
                <small>{{ total_fields }} fields managed</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title mb-1">
                            <i class="fas fa-store me-2"></i>Suppliers
                        </h6>
                        <h3 class="mb-0">{{ total_suppliers }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-handshake fa-2x opacity-50"></i>
                    </div>
                </div>
                <small>Active vendor relationships</small>
            </div>
        </div>
    </div>
</div>

<!-- AI Insights Section -->
{% if ai_insights %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-robot me-2"></i>AI-Powered Farming Insights
                </h5>
            </div>
            <div class="card-body">
                <div class="ai-insights">
                    {{ ai_insights|safe }}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Current Season Info -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info d-flex align-items-center" role="alert">
            <i class="fas fa-calendar-alt me-3"></i>
            <div>
                <strong>Current Season: {{ current_season }}</strong>
                {% if seasonal_expenses > 0 %}
                - You've spent ₹{{ "%.2f"|format(seasonal_expenses) }} this season
                {% endif %}
                <br>
                <small>Plan your expenses according to the seasonal farming calendar</small>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 col-lg-3 mb-2">
                        <a href="{{ url_for('add_comprehensive_expense') }}" class="btn btn-success btn-block w-100">
                            <i class="fas fa-plus me-2"></i>Add Expense
                        </a>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-2">
                        <a href="{{ url_for('ai_chat') }}" class="btn btn-primary btn-block w-100">
                            <i class="fas fa-robot me-2"></i>AI Advice
                        </a>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-2">
                        <a href="{{ url_for('manage_suppliers') }}" class="btn btn-info btn-block w-100">
                            <i class="fas fa-store me-2"></i>Suppliers
                        </a>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-2">
                        <a href="{{ url_for('manage_fields') }}" class="btn btn-warning btn-block w-100">
                            <i class="fas fa-mountain me-2"></i>Fields
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Category Breakdown -->
{% if category_breakdown %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Expense by Category</h5>
            </div>
            <div class="card-body">
                {% for category, amount in category_breakdown.items() %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-capitalize">{{ category.replace('_', ' ') }}</span>
                    <span class="badge bg-primary">₹{{ "%.2f"|format(amount) }}</span>
                </div>
                <div class="progress mb-3" style="height: 6px;">
                    <div class="progress-bar" role="progressbar" 
                         style="width: {{ (amount / total_expenses * 100)|round(1) }}%"></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Recent Activities -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Activities</h5>
            </div>
            <div class="card-body">
                {% if recent_activities %}
                    {% for activity in recent_activities %}
                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 border-bottom">
                        <div class="flex-grow-1">
                            <div class="fw-bold">{{ activity.description }}</div>
                            <small class="text-muted">
                                {{ activity.category }}
                                {% if activity.quantity_display %}
                                - {{ activity.quantity_display }}
                                {% endif %}
                                {% if activity.supplier %}
                                - {{ activity.supplier }}
                                {% endif %}
                            </small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">₹{{ "%.2f"|format(activity.amount) }}</div>
                            <small class="text-muted">{{ activity.date.strftime('%d %b') if activity.date else 'No date' }}</small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted mb-0">No recent activities found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Legacy Bills Section (for backward compatibility) -->
{% if bills %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Legacy Fertilizer Bills</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for bill in bills %}
                    <div class="col-lg-6 col-md-12 mb-3">
                        <div class="card border-start border-primary border-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title">{{ bill.bill_number or 'BILL-' + bill.id|string }}</h6>
                                        <p class="text-muted mb-1">{{ bill.purchase_date.strftime('%d %B %Y') }}</p>
                                        <small>{{ bill.fertilizer_count }} items</small>
                                    </div>
                                    <div class="text-end">
                                        <h5 class="text-primary">₹{{ "%.2f"|format(bill.total_amount) }}</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Getting Started (for new users) -->
{% if total_expenses == 0 %}
<div class="row">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body text-center py-5">
                <i class="fas fa-seedling fa-4x text-success mb-4"></i>
                <h3>Welcome to Your Comprehensive Farm Manager!</h3>
                <p class="lead">Start tracking your farming expenses with our comprehensive system:</p>
                <div class="row mt-4">
                    <div class="col-md-3 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <i class="fas fa-plus-circle fa-2x text-success mb-3"></i>
                                <h5>Add Expenses</h5>
                                <p class="small">Track fertilizers, labor, equipment, and more with quantities</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <i class="fas fa-mountain fa-2x text-info mb-3"></i>
                                <h5>Setup Fields</h5>
                                <p class="small">Define your plots to track field-specific expenses</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <i class="fas fa-handshake fa-2x text-warning mb-3"></i>
                                <h5>Add Suppliers</h5>
                                <p class="small">Manage vendor relationships and payment terms</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <i class="fas fa-robot fa-2x text-primary mb-3"></i>
                                <h5>AI Insights</h5>
                                <p class="small">Get personalized farming advice and cost optimization tips</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="{{ url_for('add_comprehensive_expense') }}" class="btn btn-success btn-lg me-3">
                        <i class="fas fa-plus me-2"></i>Add Your First Expense
                    </a>
                    <a href="{{ url_for('ai_chat') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-robot me-2"></i>Ask AI for Advice
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.ai-insights {
    white-space: pre-wrap;
    line-height: 1.6;
}

.border-start {
    border-left: 0.25rem solid !important;
}

.border-4 {
    border-width: 4px !important;
}

.btn-block {
    width: 100%;
}

.progress {
    background-color: rgba(0,0,0,0.1);
}
</style>
{% endblock %}